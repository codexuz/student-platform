<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Test Builder</title>
    <style>
      :root {
        --primary: #4f46e5;
        --primary-light: #818cf8;
        --primary-dark: #3730a3;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --radius: 8px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        --shadow-md:
          0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
        --shadow-lg:
          0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
        background: var(--gray-100);
        color: var(--gray-800);
        line-height: 1.6;
      }

      /* HEADER */
      .header {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: #fff;
        padding: 14px 32px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--shadow-md);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .header h1 {
        font-size: 20px;
        font-weight: 700;
      }
      .header-actions {
        display: flex;
        gap: 10px;
      }

      /* CONFIG BAR */
      .config-bar {
        background: #fff;
        border-bottom: 1px solid var(--gray-200);
        padding: 10px 32px;
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }
      .config-bar label {
        font-size: 12px;
        font-weight: 600;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
      }
      .config-bar input {
        padding: 6px 10px;
        border: 1.5px solid var(--gray-300);
        border-radius: 6px;
        font-size: 13px;
        font-family: "JetBrains Mono", "Fira Code", monospace;
        color: var(--gray-800);
      }
      .config-bar input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }
      .config-group {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* BUTTONS */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.15s;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
      }
      .btn-primary {
        background: var(--primary);
        color: #fff;
      }
      .btn-primary:hover {
        background: var(--primary-dark);
      }
      .btn-success {
        background: var(--success);
        color: #fff;
      }
      .btn-warning {
        background: var(--warning);
        color: #fff;
      }
      .btn-danger {
        background: var(--danger);
        color: #fff;
      }
      .btn-outline {
        background: transparent;
        border: 1.5px solid var(--gray-300);
        color: var(--gray-700);
      }
      .btn-outline:hover {
        border-color: var(--primary);
        color: var(--primary);
      }
      .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
      }
      .btn-xs {
        padding: 3px 8px;
        font-size: 11px;
      }

      /* LAYOUT */
      .app-layout {
        display: flex;
        height: calc(100vh - 56px - 44px);
      }
      .sidebar {
        width: 260px;
        background: #fff;
        border-right: 1px solid var(--gray-200);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .sidebar-header {
        padding: 14px 16px;
        border-bottom: 1px solid var(--gray-200);
      }
      .sidebar-header h3 {
        font-size: 14px;
        font-weight: 600;
        color: var(--gray-700);
      }
      .sidebar-body {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
      }
      .nav-section {
        margin-bottom: 4px;
      }
      .nav-section-title {
        padding: 8px 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--gray-400);
      }
      .nav-item {
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: var(--gray-600);
        transition: all 0.1s;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .nav-item:hover {
        background: var(--gray-100);
        color: var(--gray-800);
      }
      .nav-item.active {
        background: #eef2ff;
        color: var(--primary);
        font-weight: 600;
      }
      .nav-item .badge {
        margin-left: auto;
        background: var(--gray-200);
        color: var(--gray-600);
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 600;
      }
      .nav-item.active .badge {
        background: #c7d2fe;
        color: var(--primary-dark);
      }

      /* MAIN */
      .main-area {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
      }
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }

      /* CARDS */
      .card {
        background: #fff;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        margin-bottom: 16px;
      }
      .card-header {
        padding: 14px 18px;
        border-bottom: 1px solid var(--gray-100);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .card-header h3 {
        font-size: 15px;
        font-weight: 600;
      }
      .card-body {
        padding: 18px;
      }

      /* FORMS */
      .form-group {
        margin-bottom: 14px;
      }
      .form-group label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: var(--gray-600);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .form-control {
        width: 100%;
        padding: 9px 12px;
        border: 1.5px solid var(--gray-300);
        border-radius: 6px;
        font-size: 14px;
        color: var(--gray-800);
        background: #fff;
        transition: border 0.15s;
        font-family: inherit;
      }
      .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }
      select.form-control {
        cursor: pointer;
      }
      textarea.form-control {
        resize: vertical;
        min-height: 80px;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .form-row-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }

      /* TABLE */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .data-table th {
        text-align: left;
        padding: 10px 14px;
        background: var(--gray-50);
        border-bottom: 2px solid var(--gray-200);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: var(--gray-500);
        font-weight: 700;
      }
      .data-table td {
        padding: 10px 14px;
        border-bottom: 1px solid var(--gray-100);
      }
      .data-table tr:hover td {
        background: var(--gray-50);
      }
      .data-table .actions {
        display: flex;
        gap: 6px;
      }

      /* BADGES */
      .status-badge {
        font-size: 11px;
        font-weight: 700;
        padding: 3px 8px;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .status-draft {
        background: #fef3c7;
        color: #92400e;
      }
      .status-published {
        background: #d1fae5;
        color: #065f46;
      }
      .id-badge {
        font-size: 11px;
        font-family: "JetBrains Mono", "Fira Code", monospace;
        background: var(--gray-100);
        padding: 2px 6px;
        border-radius: 4px;
        color: var(--gray-500);
        cursor: pointer;
      }
      .id-badge:hover {
        background: var(--gray-200);
      }

      /* BREADCRUMB */
      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--gray-400);
        margin-bottom: 16px;
      }
      .breadcrumb a {
        color: var(--primary);
        text-decoration: none;
        cursor: pointer;
        font-weight: 500;
      }
      .breadcrumb a:hover {
        text-decoration: underline;
      }
      .breadcrumb .sep {
        color: var(--gray-300);
      }

      /* QUESTION CONTENT TYPES */
      .type-badge {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        padding: 2px 8px;
        border-radius: 4px;
        letter-spacing: 0.3px;
      }
      .type-completion {
        background: #dbeafe;
        color: #1d4ed8;
      }
      .type-multiple-choice {
        background: #fce7f3;
        color: #be185d;
      }
      .type-multi-select {
        background: #ede9fe;
        color: #6d28d9;
      }
      .type-selection {
        background: #d1fae5;
        color: #065f46;
      }
      .type-draggable-selection {
        background: #fef3c7;
        color: #92400e;
      }
      .type-matching-information {
        background: #fce4ec;
        color: #880e4f;
      }

      /* QUESTION BLOCK */
      .question-block {
        border: 1px dashed var(--gray-300);
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        background: var(--gray-50);
        position: relative;
      }
      .question-block-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      /* OPTIONS */
      .options-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 8px;
      }
      .option-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .option-row .option-label {
        width: 28px;
        height: 28px;
        background: var(--gray-200);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        color: var(--gray-600);
        flex-shrink: 0;
      }

      /* MCQ */
      .mcq-item {
        border: 1px solid var(--gray-200);
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 8px;
        background: #fff;
      }

      /* PART CARD */
      .part-card {
        border: 1.5px solid var(--gray-200);
        border-radius: var(--radius);
        margin-bottom: 12px;
        overflow: hidden;
      }
      .part-card-header {
        padding: 10px 14px;
        background: var(--gray-50);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
      }
      .part-card-header h4 {
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .part-card-header .chevron {
        transition: transform 0.2s;
        font-size: 12px;
        color: var(--gray-400);
      }
      .part-card-header.collapsed .chevron {
        transform: rotate(-90deg);
      }
      .part-card-body {
        padding: 14px;
        border-top: 1px solid var(--gray-100);
      }
      .part-card-body.collapsed {
        display: none;
      }

      /* EMPTY */
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: var(--gray-400);
      }
      .empty-state .icon {
        font-size: 48px;
        margin-bottom: 12px;
      }
      .empty-state h3 {
        font-size: 16px;
        color: var(--gray-500);
        margin-bottom: 6px;
      }
      .empty-state p {
        font-size: 13px;
      }

      /* MODAL */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 200;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
      }
      .modal-overlay.open {
        opacity: 1;
        visibility: visible;
      }
      .modal {
        background: #fff;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        width: 90%;
        max-width: 600px;
        max-height: 85vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: transform 0.2s;
      }
      .modal-overlay.open .modal {
        transform: translateY(0);
      }
      .modal-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .modal-header h3 {
        font-size: 16px;
        font-weight: 700;
      }
      .modal-close {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: var(--gray-100);
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-500);
      }
      .modal-close:hover {
        background: var(--gray-200);
      }
      .modal-body {
        padding: 20px;
      }
      .modal-footer {
        padding: 14px 20px;
        border-top: 1px solid var(--gray-200);
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      /* TOAST */
      .toast-container {
        position: fixed;
        top: 72px;
        right: 20px;
        z-index: 300;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .toast {
        padding: 10px 16px;
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 600;
        color: #fff;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.3s ease;
      }
      .toast-success {
        background: var(--success);
      }
      .toast-error {
        background: var(--danger);
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* SCROLLBAR */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--gray-400);
      }

      /* UTILS */
      .mt-2 {
        margin-top: 8px;
      }
      .mt-3 {
        margin-top: 12px;
      }
      .mt-4 {
        margin-top: 16px;
      }
      .mb-2 {
        margin-bottom: 8px;
      }
      .mb-3 {
        margin-bottom: 12px;
      }
      .flex {
        display: flex;
      }
      .items-center {
        align-items: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .gap-2 {
        gap: 8px;
      }
      .text-sm {
        font-size: 13px;
      }
      .text-gray {
        color: var(--gray-500);
      }
      .fw-600 {
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <!-- HEADER -->
    <header class="header">
      <h1>üìù IELTS Test Builder</h1>
      <div class="header-actions">
        <button
          class="btn btn-outline"
          style="color: #fff; border-color: rgba(255, 255, 255, 0.3)"
          onclick="navigateTo('tests')"
        >
          üìã All Tests
        </button>
      </div>
    </header>

    <!-- CONFIG BAR -->
    <div class="config-bar">
      <div class="config-group">
        <label>API URL</label>
        <input
          type="text"
          id="api-url"
          value="http://localhost:3000"
          style="width: 220px"
        />
      </div>
      <div class="config-group">
        <label>JWT Token</label>
        <input
          type="text"
          id="jwt-token"
          style="width: 400px"
          placeholder="Paste your Bearer token..."
        />
      </div>
    </div>

    <!-- APP LAYOUT -->
    <div class="app-layout">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-header"><h3>Navigation</h3></div>
        <div class="sidebar-body">
          <div class="nav-section">
            <div class="nav-section-title">Manage</div>
            <div
              class="nav-item active"
              onclick="navigateTo('tests')"
              data-nav="tests"
            >
              <span>üìã</span> Tests
            </div>
            <div
              class="nav-item"
              onclick="navigateTo('readings')"
              data-nav="readings"
            >
              <span>üìñ</span> Readings
            </div>
            <div
              class="nav-item"
              onclick="navigateTo('reading-parts')"
              data-nav="reading-parts"
            >
              <span>üìÑ</span> Reading Parts
            </div>
            <div
              class="nav-item"
              onclick="navigateTo('listenings')"
              data-nav="listenings"
            >
              <span>üéß</span> Listenings
            </div>
            <div
              class="nav-item"
              onclick="navigateTo('listening-parts')"
              data-nav="listening-parts"
            >
              <span>üîä</span> Listening Parts
            </div>
            <div
              class="nav-item"
              onclick="navigateTo('writings')"
              data-nav="writings"
            >
              <span>‚úçÔ∏è</span> Writings
            </div>
            <div
              class="nav-item"
              onclick="navigateTo('writing-tasks')"
              data-nav="writing-tasks"
            >
              <span>üìù</span> Writing Tasks
            </div>
          </div>
        </div>
      </aside>

      <!-- MAIN AREA -->
      <main class="main-area">
        <!-- ==================== PAGE: TESTS ==================== -->
        <div id="page-tests" class="page active">
          <div class="flex items-center justify-between mb-3">
            <h2 style="font-size: 18px; font-weight: 700">üìã Tests</h2>
            <button
              class="btn btn-primary btn-sm"
              onclick="showCreateTestForm()"
            >
              + Create Test
            </button>
          </div>
          <div id="tests-list-container">
            <div class="empty-state">
              <div class="icon">üìã</div>
              <h3>Loading tests...</h3>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: CREATE/EDIT TEST ==================== -->
        <div id="page-test-form" class="page">
          <div class="breadcrumb">
            <a onclick="navigateTo('tests')">Tests</a>
            <span class="sep">/</span>
            <span id="test-form-title">Create Test</span>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 id="test-form-heading">Create New Test</h3>
            </div>
            <div class="card-body">
              <input type="hidden" id="test-edit-id" />
              <div class="form-group">
                <label>Test Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="test-title"
                  placeholder="e.g. Cambridge IELTS 18 - Test 1"
                />
              </div>
              <div class="form-row-3">
                <div class="form-group">
                  <label>Mode</label>
                  <select class="form-control" id="test-mode">
                    <option value="practice">Practice</option>
                    <option value="mock">Mock Exam</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Status</label>
                  <select class="form-control" id="test-status">
                    <option value="draft">Draft</option>
                    <option value="published">Published</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Category</label>
                  <select class="form-control" id="test-category">
                    <option value="">-- Select --</option>
                    <option value="authentic">Authentic</option>
                    <option value="pre-test">Pre-Test</option>
                    <option value="cambridge books">Cambridge Books</option>
                  </select>
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-success" onclick="saveTest()">
                  üíæ Save Test
                </button>
                <button class="btn btn-outline" onclick="navigateTo('tests')">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: TEST DETAIL ==================== -->
        <div id="page-test-detail" class="page">
          <div class="breadcrumb">
            <a onclick="navigateTo('tests')">Tests</a>
            <span class="sep">/</span>
            <span id="test-detail-name">Test</span>
          </div>
          <div id="test-detail-content"></div>
        </div>

        <!-- ==================== PAGE: READINGS ==================== -->
        <div id="page-readings" class="page">
          <div class="flex items-center justify-between mb-3">
            <h2 style="font-size: 18px; font-weight: 700">üìñ Readings</h2>
            <button
              class="btn btn-primary btn-sm"
              onclick="showCreateReadingForm()"
            >
              + Create Reading
            </button>
          </div>
          <div id="readings-list-container">
            <div class="empty-state">
              <div class="icon">üìñ</div>
              <h3>Loading readings...</h3>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: CREATE READING ==================== -->
        <div id="page-reading-form" class="page">
          <div class="breadcrumb">
            <a onclick="navigateTo('readings')">Readings</a>
            <span class="sep">/</span>
            <span>Create Reading</span>
          </div>
          <div class="card">
            <div class="card-header"><h3>Create Reading Section</h3></div>
            <div class="card-body">
              <div class="form-group">
                <label>Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="reading-title"
                  placeholder="e.g. Academic Reading Test"
                />
              </div>
              <div class="form-group">
                <label>Test ID</label>
                <input
                  type="text"
                  class="form-control"
                  id="reading-test-id"
                  placeholder="UUID of the test this belongs to"
                />
              </div>
              <div class="flex gap-2">
                <button class="btn btn-success" onclick="saveReading()">
                  üíæ Save Reading
                </button>
                <button
                  class="btn btn-outline"
                  onclick="navigateTo('readings')"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: READING PARTS ==================== -->
        <div id="page-reading-parts" class="page">
          <div class="flex items-center justify-between mb-3">
            <h2 style="font-size: 18px; font-weight: 700">üìÑ Reading Parts</h2>
            <button
              class="btn btn-primary btn-sm"
              onclick="showCreateReadingPartForm()"
            >
              + Create Reading Part
            </button>
          </div>
          <div id="reading-parts-list-container">
            <div class="empty-state">
              <div class="icon">üìÑ</div>
              <h3>Loading reading parts...</h3>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: CREATE READING PART ==================== -->
        <div id="page-reading-part-form" class="page">
          <div class="breadcrumb">
            <a onclick="navigateTo('reading-parts')">Reading Parts</a>
            <span class="sep">/</span>
            <span>Create Reading Part</span>
          </div>
          <div class="card">
            <div class="card-header"><h3>Create Reading Part</h3></div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-group">
                  <label>Reading ID</label>
                  <input
                    type="text"
                    class="form-control"
                    id="rp-reading-id"
                    placeholder="UUID of reading section"
                  />
                </div>
                <div class="form-group">
                  <label>Part</label>
                  <select class="form-control" id="rp-part">
                    <option value="PART_1">Part 1</option>
                    <option value="PART_2">Part 2</option>
                    <option value="PART_3">Part 3</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="rp-title"
                  placeholder="e.g. The History of Astronomy"
                />
              </div>
              <div class="form-group">
                <label>Passage</label>
                <textarea
                  class="form-control"
                  id="rp-passage"
                  style="min-height: 150px"
                  placeholder="Paste the reading passage here..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>Answer Key (JSON)</label>
                <textarea
                  class="form-control"
                  id="rp-answers"
                  placeholder='{"1":"answer1","2":"answer2"}'
                ></textarea>
              </div>

              <!-- Question Groups Builder -->
              <div class="card mt-3">
                <div class="card-header">
                  <h3>Question Groups</h3>
                  <button
                    class="btn btn-primary btn-xs"
                    onclick="rpAddQuestionGroup()"
                  >
                    + Add Group
                  </button>
                </div>
                <div class="card-body" id="rp-question-groups"></div>
              </div>

              <div class="flex gap-2 mt-3">
                <button class="btn btn-success" onclick="saveReadingPart()">
                  üíæ Save Reading Part
                </button>
                <button
                  class="btn btn-outline"
                  onclick="navigateTo('reading-parts')"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: LISTENINGS ==================== -->
        <div id="page-listenings" class="page">
          <div class="flex items-center justify-between mb-3">
            <h2 style="font-size: 18px; font-weight: 700">üéß Listenings</h2>
            <button
              class="btn btn-primary btn-sm"
              onclick="showCreateListeningForm()"
            >
              + Create Listening
            </button>
          </div>
          <div id="listenings-list-container">
            <div class="empty-state">
              <div class="icon">üéß</div>
              <h3>Loading listenings...</h3>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: CREATE LISTENING ==================== -->
        <div id="page-listening-form" class="page">
          <div class="breadcrumb">
            <a onclick="navigateTo('listenings')">Listenings</a>
            <span class="sep">/</span>
            <span>Create Listening</span>
          </div>
          <div class="card">
            <div class="card-header"><h3>Create Listening Section</h3></div>
            <div class="card-body">
              <div class="form-group">
                <label>Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="listening-title"
                  placeholder="e.g. Listening Test"
                />
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea
                  class="form-control"
                  id="listening-description"
                  placeholder="Optional description..."
                ></textarea>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Test ID</label>
                  <input
                    type="text"
                    class="form-control"
                    id="listening-test-id"
                    placeholder="UUID of the test"
                  />
                </div>
                <div class="form-group">
                  <label>Full Audio URL</label>
                  <input
                    type="text"
                    class="form-control"
                    id="listening-full-audio"
                    placeholder="https://..."
                  />
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-success" onclick="saveListening()">
                  üíæ Save Listening
                </button>
                <button
                  class="btn btn-outline"
                  onclick="navigateTo('listenings')"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: LISTENING PARTS ==================== -->
        <div id="page-listening-parts" class="page">
          <div class="flex items-center justify-between mb-3">
            <h2 style="font-size: 18px; font-weight: 700">
              üîä Listening Parts
            </h2>
            <button
              class="btn btn-primary btn-sm"
              onclick="showCreateListeningPartForm()"
            >
              + Create Listening Part
            </button>
          </div>
          <div id="listening-parts-list-container">
            <div class="empty-state">
              <div class="icon">üîä</div>
              <h3>Loading listening parts...</h3>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: CREATE LISTENING PART ==================== -->
        <div id="page-listening-part-form" class="page">
          <div class="breadcrumb">
            <a onclick="navigateTo('listening-parts')">Listening Parts</a>
            <span class="sep">/</span>
            <span>Create Listening Part</span>
          </div>
          <div class="card">
            <div class="card-header"><h3>Create Listening Part</h3></div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-group">
                  <label>Listening ID</label>
                  <input
                    type="text"
                    class="form-control"
                    id="lp-listening-id"
                    placeholder="UUID of listening section"
                  />
                </div>
                <div class="form-group">
                  <label>Part</label>
                  <select class="form-control" id="lp-part">
                    <option value="PART_1">Part 1</option>
                    <option value="PART_2">Part 2</option>
                    <option value="PART_3">Part 3</option>
                    <option value="PART_4">Part 4</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="lp-title"
                  placeholder="e.g. A conversation between two students"
                />
              </div>
              <div class="form-row-3">
                <div class="form-group">
                  <label>Audio URL</label>
                  <input
                    type="text"
                    class="form-control"
                    id="lp-audio-url"
                    placeholder="https://..."
                  />
                </div>
                <div class="form-group">
                  <label>Audio File Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="lp-audio-name"
                    placeholder="part1.mp3"
                  />
                </div>
                <div class="form-group">
                  <label>Audio Duration (s)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="lp-audio-duration"
                    placeholder="300"
                  />
                </div>
              </div>
              <div class="form-group">
                <label>Answer Key (JSON)</label>
                <textarea
                  class="form-control"
                  id="lp-answers"
                  placeholder='{"1":"answer1","2":"answer2"}'
                ></textarea>
              </div>

              <!-- Question Groups Builder -->
              <div class="card mt-3">
                <div class="card-header">
                  <h3>Question Groups</h3>
                  <button
                    class="btn btn-primary btn-xs"
                    onclick="lpAddQuestionGroup()"
                  >
                    + Add Group
                  </button>
                </div>
                <div class="card-body" id="lp-question-groups"></div>
              </div>

              <div class="flex gap-2 mt-3">
                <button class="btn btn-success" onclick="saveListeningPart()">
                  üíæ Save Listening Part
                </button>
                <button
                  class="btn btn-outline"
                  onclick="navigateTo('listening-parts')"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: WRITINGS ==================== -->
        <div id="page-writings" class="page">
          <div class="flex items-center justify-between mb-3">
            <h2 style="font-size: 18px; font-weight: 700">‚úçÔ∏è Writings</h2>
            <button
              class="btn btn-primary btn-sm"
              onclick="showCreateWritingForm()"
            >
              + Create Writing
            </button>
          </div>
          <div id="writings-list-container">
            <div class="empty-state">
              <div class="icon">‚úçÔ∏è</div>
              <h3>Loading writings...</h3>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: CREATE WRITING ==================== -->
        <div id="page-writing-form" class="page">
          <div class="breadcrumb">
            <a onclick="navigateTo('writings')">Writings</a>
            <span class="sep">/</span>
            <span>Create Writing</span>
          </div>
          <div class="card">
            <div class="card-header"><h3>Create Writing Section</h3></div>
            <div class="card-body">
              <div class="form-group">
                <label>Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="writing-title"
                  placeholder="e.g. Academic Writing Test"
                />
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea
                  class="form-control"
                  id="writing-description"
                  placeholder="Optional description..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>Test ID</label>
                <input
                  type="text"
                  class="form-control"
                  id="writing-test-id"
                  placeholder="UUID of the test"
                />
              </div>
              <div class="flex gap-2">
                <button class="btn btn-success" onclick="saveWriting()">
                  üíæ Save Writing
                </button>
                <button
                  class="btn btn-outline"
                  onclick="navigateTo('writings')"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: WRITING TASKS ==================== -->
        <div id="page-writing-tasks" class="page">
          <div class="flex items-center justify-between mb-3">
            <h2 style="font-size: 18px; font-weight: 700">üìù Writing Tasks</h2>
            <button
              class="btn btn-primary btn-sm"
              onclick="showCreateWritingTaskForm()"
            >
              + Create Task
            </button>
          </div>
          <div id="writing-tasks-list-container">
            <div class="empty-state">
              <div class="icon">üìù</div>
              <h3>Create tasks from a Writing section</h3>
              <p>Use the "+ Task" button on a Writing section</p>
            </div>
          </div>
        </div>

        <!-- ==================== PAGE: CREATE WRITING TASK ==================== -->
        <div id="page-writing-task-form" class="page">
          <div class="breadcrumb">
            <a onclick="navigateTo('writing-tasks')">Writing Tasks</a>
            <span class="sep">/</span>
            <span>Create Task</span>
          </div>
          <div class="card">
            <div class="card-header"><h3>Create Writing Task</h3></div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-group">
                  <label>Writing ID</label>
                  <input
                    type="text"
                    class="form-control"
                    id="wt-writing-id"
                    placeholder="UUID of writing section"
                  />
                </div>
                <div class="form-group">
                  <label>Task</label>
                  <select class="form-control" id="wt-task">
                    <option value="TASK_1">Task 1</option>
                    <option value="TASK_2">Task 2</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Prompt</label>
                <textarea
                  class="form-control"
                  id="wt-prompt"
                  style="min-height: 120px"
                  placeholder="Write the task prompt here..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>Instructions</label>
                <textarea
                  class="form-control"
                  id="wt-instructions"
                  placeholder="Additional instructions..."
                ></textarea>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Minimum Words</label>
                  <input
                    type="number"
                    class="form-control"
                    id="wt-min-words"
                    value="150"
                  />
                </div>
                <div class="form-group">
                  <label>Suggested Time (minutes)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="wt-suggested-time"
                    value="20"
                  />
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-success" onclick="saveWritingTask()">
                  üíæ Save Task
                </button>
                <button
                  class="btn btn-outline"
                  onclick="navigateTo('writing-tasks')"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- QUESTION CONTENT MODAL -->
    <div class="modal-overlay" id="qc-modal">
      <div class="modal" style="max-width: 640px">
        <div class="modal-header">
          <h3>Add Question Content</h3>
          <button class="modal-close" onclick="closeModal('qc-modal')">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Question Type</label>
            <select
              class="form-control"
              id="qc-type"
              onchange="onQcTypeChange()"
            >
              <option value="completion">
                Completion (Fill in the blanks)
              </option>
              <option value="multiple-choice">Multiple Choice</option>
              <option value="multi-select">Multi Select</option>
              <option value="selection">
                Selection (True/False/Not Given)
              </option>
              <option value="draggable-selection">Draggable Selection</option>
              <option value="matching-information">Matching Information</option>
            </select>
          </div>
          <div class="form-group">
            <label>Title</label>
            <input
              type="text"
              class="form-control"
              id="qc-title"
              placeholder="e.g. Questions 1-6"
            />
          </div>
          <div class="form-group">
            <label>Condition / Instructions</label>
            <textarea
              class="form-control"
              id="qc-condition"
              placeholder="e.g. Complete the sentences below..."
            ></textarea>
          </div>
          <div class="form-group">
            <label>Content (HTML allowed)</label>
            <textarea
              class="form-control"
              id="qc-content"
              style="min-height: 100px"
              placeholder="Main content with blanks like {{1}}, {{2}}..."
            ></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Word Limit</label
              ><input
                type="number"
                class="form-control"
                id="qc-limit"
                placeholder="e.g. 2"
              />
            </div>
            <div class="form-group">
              <label>Order</label
              ><input
                type="number"
                class="form-control"
                id="qc-order"
                placeholder="1"
              />
            </div>
          </div>
          <div class="form-group" id="qc-show-options-group">
            <label
              ><input type="checkbox" id="qc-show-options" checked /> Show
              Options</label
            >
          </div>
          <div class="form-group" id="qc-options-title-group">
            <label>Options Title</label>
            <input
              type="text"
              class="form-control"
              id="qc-options-title"
              placeholder="e.g. List of headings"
            />
          </div>
          <div id="qc-options-builder" style="display: none">
            <div class="flex items-center justify-between mb-2">
              <label style="margin-bottom: 0">Options</label>
              <button class="btn btn-outline btn-xs" onclick="qcAddOption()">
                + Add Option
              </button>
            </div>
            <div id="qc-options-list" class="options-list"></div>
          </div>
          <div id="qc-mcq-builder" style="display: none">
            <div class="flex items-center justify-between mb-2">
              <label style="margin-bottom: 0">Multiple Choice Questions</label>
              <button class="btn btn-outline btn-xs" onclick="qcAddMcq()">
                + Add MCQ
              </button>
            </div>
            <div id="qc-mcq-list"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('qc-modal')">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="qcSaveContent()">
            Add Content
          </button>
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div class="toast-container" id="toast-container"></div>

    <script>
      // ============================================================
      //  API HELPERS
      // ============================================================
      function getApiUrl() {
        return document.getElementById("api-url").value.replace(/\/+$/, "");
      }
      function getHeaders() {
        return {
          "Content-Type": "application/json",
          Authorization:
            "Bearer " + document.getElementById("jwt-token").value.trim(),
        };
      }
      async function apiPost(path, body) {
        const res = await fetch(getApiUrl() + path, {
          method: "POST",
          headers: getHeaders(),
          body: JSON.stringify(body),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok)
          throw new Error(
            Array.isArray(data.message)
              ? data.message.join(", ")
              : data.message || JSON.stringify(data) || `Error ${res.status}`,
          );
        return data;
      }
      async function apiGet(path) {
        const res = await fetch(getApiUrl() + path, { headers: getHeaders() });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || `Error ${res.status}`);
        return data;
      }
      async function apiPatch(path, body) {
        const res = await fetch(getApiUrl() + path, {
          method: "PATCH",
          headers: getHeaders(),
          body: JSON.stringify(body),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || `Error ${res.status}`);
        return data;
      }
      async function apiDelete(path) {
        const res = await fetch(getApiUrl() + path, {
          method: "DELETE",
          headers: getHeaders(),
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.message || `Error ${res.status}`);
        }
        return true;
      }

      // ============================================================
      //  NAVIGATION
      // ============================================================
      const pageLoaders = {
        tests: loadTests,
        readings: loadReadings,
        "reading-parts": loadReadingParts,
        listenings: loadListenings,
        "listening-parts": loadListeningParts,
        writings: loadWritings,
        "writing-tasks": loadWritingTasks,
      };

      function navigateTo(pageId) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        const el = document.getElementById("page-" + pageId);
        if (el) el.classList.add("active");
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        const nav = document.querySelector(`[data-nav="${pageId}"]`);
        if (nav) nav.classList.add("active");
        if (pageLoaders[pageId]) pageLoaders[pageId]();
      }

      function showPage(pageId) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document.getElementById(pageId).classList.add("active");
      }

      // ============================================================
      //  HELPERS
      // ============================================================
      function toast(msg, type = "success") {
        const c = document.getElementById("toast-container");
        const t = document.createElement("div");
        t.className = `toast toast-${type}`;
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(() => t.remove(), 3500);
      }
      function openModal(id) {
        document.getElementById(id).classList.add("open");
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("open");
      }
      function truncId(id) {
        return id ? id.substring(0, 8) + "..." : "-";
      }
      function copyId(id) {
        navigator.clipboard.writeText(id).then(() => toast("ID copied!"));
      }
      function truncate(s, n) {
        return s && s.length > n ? s.substring(0, n) + "..." : s || "";
      }

      // ============================================================
      //  TESTS
      // ============================================================
      async function loadTests() {
        const c = document.getElementById("tests-list-container");
        c.innerHTML = '<p class="text-sm text-gray">Loading...</p>';
        try {
          const data = await apiGet("/ielts-tests?limit=100");
          const tests = data.data || data;
          if (!tests || !tests.length) {
            c.innerHTML =
              '<div class="empty-state"><div class="icon">üìã</div><h3>No tests yet</h3><p>Create your first test</p></div>';
            return;
          }
          c.innerHTML = `<table class="data-table">
      <thead><tr><th>Title</th><th>Mode</th><th>Category</th><th>Status</th><th>ID</th><th>Actions</th></tr></thead>
      <tbody>${tests
        .map(
          (t) => `<tr>
        <td class="fw-600">${t.title || "Untitled"}</td>
        <td>${t.mode}</td>
        <td>${t.category || "-"}</td>
        <td><span class="status-badge ${t.status === "published" ? "status-published" : "status-draft"}">${t.status}</span></td>
        <td><span class="id-badge" onclick="copyId('${t.id}')" title="${t.id}">${truncId(t.id)}</span></td>
        <td class="actions">
          <button class="btn btn-primary btn-xs" onclick="viewTestDetail('${t.id}')">View</button>
          <button class="btn btn-outline btn-xs" onclick="editTest('${t.id}')">Edit</button>
          <button class="btn btn-danger btn-xs" onclick="deleteTest('${t.id}')">Del</button>
        </td>
      </tr>`,
        )
        .join("")}</tbody></table>`;
        } catch (e) {
          c.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
        }
      }

      function showCreateTestForm() {
        document.getElementById("test-edit-id").value = "";
        document.getElementById("test-title").value = "";
        document.getElementById("test-mode").value = "practice";
        document.getElementById("test-status").value = "draft";
        document.getElementById("test-category").value = "";
        document.getElementById("test-form-title").textContent = "Create Test";
        document.getElementById("test-form-heading").textContent =
          "Create New Test";
        showPage("page-test-form");
      }

      async function editTest(id) {
        try {
          const t = await apiGet(`/ielts-tests/${id}`);
          document.getElementById("test-edit-id").value = t.id;
          document.getElementById("test-title").value = t.title || "";
          document.getElementById("test-mode").value = t.mode || "practice";
          document.getElementById("test-status").value = t.status || "draft";
          document.getElementById("test-category").value = t.category || "";
          document.getElementById("test-form-title").textContent = "Edit Test";
          document.getElementById("test-form-heading").textContent =
            "Edit Test";
          showPage("page-test-form");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      async function saveTest() {
        const editId = document.getElementById("test-edit-id").value;
        const body = {
          title: document.getElementById("test-title").value,
          mode: document.getElementById("test-mode").value,
          status: document.getElementById("test-status").value,
        };
        const cat = document.getElementById("test-category").value;
        if (cat) body.category = cat;
        try {
          if (editId) {
            await apiPatch(`/ielts-tests/${editId}`, body);
            toast("Test updated!");
          } else {
            const r = await apiPost("/ielts-tests", body);
            toast(`Test created! ID: ${r.id}`);
          }
          navigateTo("tests");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      async function deleteTest(id) {
        if (!confirm("Delete this test?")) return;
        try {
          await apiDelete(`/ielts-tests/${id}`);
          toast("Test deleted!");
          loadTests();
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      async function viewTestDetail(id) {
        showPage("page-test-detail");
        const c = document.getElementById("test-detail-content");
        c.innerHTML = '<p class="text-sm text-gray">Loading...</p>';
        try {
          const t = await apiGet(`/ielts-tests/${id}`);
          document.getElementById("test-detail-name").textContent =
            t.title || "Test";
          let html = `
      <div class="card">
        <div class="card-header">
          <h3>${t.title}</h3>
          <span class="status-badge ${t.status === "published" ? "status-published" : "status-draft"}">${t.status}</span>
        </div>
        <div class="card-body">
          <div class="form-row-3 mb-3">
            <div><label class="text-sm text-gray">MODE</label><div class="fw-600">${t.mode}</div></div>
            <div><label class="text-sm text-gray">CATEGORY</label><div class="fw-600">${t.category || "-"}</div></div>
            <div><label class="text-sm text-gray">ID</label><div><span class="id-badge" onclick="copyId('${t.id}')">${t.id}</span></div></div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="createReadingForTest('${t.id}')">+ Reading</button>
            <button class="btn btn-primary btn-sm" onclick="createListeningForTest('${t.id}')">+ Listening</button>
            <button class="btn btn-primary btn-sm" onclick="createWritingForTest('${t.id}')">+ Writing</button>
          </div>
        </div>
      </div>`;

          if (t.readings && t.readings.length) {
            html += `<div class="card"><div class="card-header"><h3>üìñ Readings</h3></div><div class="card-body">
        <table class="data-table"><thead><tr><th>Title</th><th>ID</th><th>Parts</th><th>Actions</th></tr></thead><tbody>
        ${t.readings
          .map(
            (r) => `<tr>
          <td class="fw-600">${r.title || "-"}</td>
          <td><span class="id-badge" onclick="copyId('${r.id}')">${truncId(r.id)}</span></td>
          <td>${(r.parts || []).length} parts</td>
          <td class="actions"><button class="btn btn-primary btn-xs" onclick="createReadingPartFor('${r.id}')">+ Part</button></td>
        </tr>`,
          )
          .join("")}
        </tbody></table></div></div>`;
          }
          if (t.listenings && t.listenings.length) {
            html += `<div class="card"><div class="card-header"><h3>üéß Listenings</h3></div><div class="card-body">
        <table class="data-table"><thead><tr><th>Title</th><th>ID</th><th>Parts</th><th>Actions</th></tr></thead><tbody>
        ${t.listenings
          .map(
            (l) => `<tr>
          <td class="fw-600">${l.title || "-"}</td>
          <td><span class="id-badge" onclick="copyId('${l.id}')">${truncId(l.id)}</span></td>
          <td>${(l.parts || []).length} parts</td>
          <td class="actions"><button class="btn btn-primary btn-xs" onclick="createListeningPartFor('${l.id}')">+ Part</button></td>
        </tr>`,
          )
          .join("")}
        </tbody></table></div></div>`;
          }
          if (t.writings && t.writings.length) {
            html += `<div class="card"><div class="card-header"><h3>‚úçÔ∏è Writings</h3></div><div class="card-body">
        <table class="data-table"><thead><tr><th>Title</th><th>ID</th><th>Tasks</th><th>Actions</th></tr></thead><tbody>
        ${t.writings
          .map(
            (w) => `<tr>
          <td class="fw-600">${w.title || "-"}</td>
          <td><span class="id-badge" onclick="copyId('${w.id}')">${truncId(w.id)}</span></td>
          <td>${(w.tasks || []).length} tasks</td>
          <td class="actions"><button class="btn btn-primary btn-xs" onclick="createWritingTaskFor('${w.id}')">+ Task</button></td>
        </tr>`,
          )
          .join("")}
        </tbody></table></div></div>`;
          }
          c.innerHTML = html;
        } catch (e) {
          c.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
        }
      }

      // Quick-create linked entities from test detail
      function createReadingForTest(testId) {
        showCreateReadingForm();
        document.getElementById("reading-test-id").value = testId;
      }
      function createListeningForTest(testId) {
        showCreateListeningForm();
        document.getElementById("listening-test-id").value = testId;
      }
      function createWritingForTest(testId) {
        showCreateWritingForm();
        document.getElementById("writing-test-id").value = testId;
      }
      function createReadingPartFor(readingId) {
        showCreateReadingPartForm();
        document.getElementById("rp-reading-id").value = readingId;
      }
      function createListeningPartFor(listeningId) {
        showCreateListeningPartForm();
        document.getElementById("lp-listening-id").value = listeningId;
      }
      function createWritingTaskFor(writingId) {
        showCreateWritingTaskForm();
        document.getElementById("wt-writing-id").value = writingId;
      }

      // ============================================================
      //  READINGS
      // ============================================================
      async function loadReadings() {
        const c = document.getElementById("readings-list-container");
        c.innerHTML = '<p class="text-sm text-gray">Loading...</p>';
        try {
          const data = await apiGet("/ielts-reading?limit=100");
          const items = data.data || data;
          if (!items || !items.length) {
            c.innerHTML =
              '<div class="empty-state"><div class="icon">üìñ</div><h3>No readings yet</h3></div>';
            return;
          }
          c.innerHTML = `<table class="data-table">
      <thead><tr><th>Title</th><th>Test ID</th><th>ID</th><th>Actions</th></tr></thead>
      <tbody>${items
        .map(
          (r) => `<tr>
        <td class="fw-600">${r.title || "-"}</td>
        <td><span class="id-badge" onclick="copyId('${r.test_id || ""}')">${truncId(r.test_id)}</span></td>
        <td><span class="id-badge" onclick="copyId('${r.id}')">${truncId(r.id)}</span></td>
        <td class="actions">
          <button class="btn btn-primary btn-xs" onclick="createReadingPartFor('${r.id}')">+ Part</button>
          <button class="btn btn-danger btn-xs" onclick="deleteReading('${r.id}')">Del</button>
        </td>
      </tr>`,
        )
        .join("")}</tbody></table>`;
        } catch (e) {
          c.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
        }
      }

      function showCreateReadingForm() {
        document.getElementById("reading-title").value = "";
        document.getElementById("reading-test-id").value = "";
        showPage("page-reading-form");
      }

      async function saveReading() {
        try {
          const body = {
            title: document.getElementById("reading-title").value,
            test_id: document.getElementById("reading-test-id").value,
          };
          const r = await apiPost("/ielts-reading", body);
          toast(`Reading created! ID: ${r.id}`);
          navigateTo("readings");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      async function deleteReading(id) {
        if (!confirm("Delete this reading?")) return;
        try {
          await apiDelete(`/ielts-reading/${id}`);
          toast("Reading deleted!");
          loadReadings();
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      // ============================================================
      //  READING PARTS
      // ============================================================
      let rpQuestionGroups = [];

      async function loadReadingParts() {
        const c = document.getElementById("reading-parts-list-container");
        c.innerHTML = '<p class="text-sm text-gray">Loading...</p>';
        try {
          const data = await apiGet("/ielts-reading-parts?limit=100");
          const items = data.data || data;
          if (!items || !items.length) {
            c.innerHTML =
              '<div class="empty-state"><div class="icon">üìÑ</div><h3>No reading parts yet</h3></div>';
            return;
          }
          c.innerHTML = `<table class="data-table">
      <thead><tr><th>Part</th><th>Title</th><th>Reading ID</th><th>ID</th><th>Actions</th></tr></thead>
      <tbody>${items
        .map(
          (p) => `<tr>
        <td class="fw-600">${p.part}</td>
        <td>${p.title || "-"}</td>
        <td><span class="id-badge" onclick="copyId('${p.reading_id || ""}')">${truncId(p.reading_id)}</span></td>
        <td><span class="id-badge" onclick="copyId('${p.id}')">${truncId(p.id)}</span></td>
        <td class="actions">
          <button class="btn btn-outline btn-xs" onclick="editReadingPart('${p.id}')">Edit</button>
          <button class="btn btn-danger btn-xs" onclick="deleteReadingPart('${p.id}')">Del</button>
        </td>
      </tr>`,
        )
        .join("")}</tbody></table>`;
        } catch (e) {
          c.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
        }
      }

      let rpEditId = null;

      function showCreateReadingPartForm() {
        rpEditId = null;
        rpQuestionGroups = [];
        document.getElementById("rp-reading-id").value = "";
        document.getElementById("rp-part").value = "PART_1";
        document.getElementById("rp-title").value = "";
        document.getElementById("rp-passage").value = "";
        document.getElementById("rp-answers").value = "";
        document.querySelector(
          "#page-reading-part-form .card-header h3",
        ).textContent = "Create Reading Part";
        renderRpQuestionGroups();
        showPage("page-reading-part-form");
      }

      async function editReadingPart(id) {
        try {
          const p = await apiGet(`/ielts-reading-parts/${id}`);
          rpEditId = p.id;
          document.getElementById("rp-reading-id").value = p.reading_id || "";
          document.getElementById("rp-part").value = p.part || "PART_1";
          document.getElementById("rp-title").value = p.title || "";
          document.getElementById("rp-passage").value = p.passage || "";
          document.getElementById("rp-answers").value = p.answers
            ? JSON.stringify(p.answers, null, 2)
            : "";
          rpQuestionGroups = (p.questions || []).map((q) => ({
            number_of_questions: q.number_of_questions || 0,
            contents: (q.contents || []).map((c) => ({ ...c })),
          }));
          document.querySelector(
            "#page-reading-part-form .card-header h3",
          ).textContent = "Edit Reading Part";
          renderRpQuestionGroups();
          showPage("page-reading-part-form");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      function rpAddQuestionGroup() {
        rpQuestionGroups.push({ number_of_questions: 10, contents: [] });
        renderRpQuestionGroups();
      }
      function rpRemoveQuestionGroup(idx) {
        rpQuestionGroups.splice(idx, 1);
        renderRpQuestionGroups();
      }
      function renderRpQuestionGroups() {
        renderQuestionGroups("rp-question-groups", rpQuestionGroups, "rp");
      }

      async function saveReadingPart() {
        try {
          let answers = null;
          const av = document.getElementById("rp-answers").value.trim();
          if (av) {
            try {
              answers = JSON.parse(av);
            } catch (e) {
              toast("Invalid JSON in answers", "error");
              return;
            }
          }
          const body = {
            reading_id: document.getElementById("rp-reading-id").value,
            part: document.getElementById("rp-part").value,
            title: document.getElementById("rp-title").value || null,
            passage: document.getElementById("rp-passage").value || null,
            answers,
            questions: rpQuestionGroups.map((q) => ({
              number_of_questions: q.number_of_questions,
              contents: q.contents.map(buildContentPayload),
            })),
          };
          if (rpEditId) {
            await apiPatch(`/ielts-reading-parts/${rpEditId}`, body);
            toast("Reading part updated!");
          } else {
            const r = await apiPost("/ielts-reading-parts", body);
            toast(`Reading part created! ID: ${r.id}`);
          }
          rpEditId = null;
          navigateTo("reading-parts");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      async function deleteReadingPart(id) {
        if (!confirm("Delete this reading part?")) return;
        try {
          await apiDelete(`/ielts-reading-parts/${id}`);
          toast("Deleted!");
          loadReadingParts();
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      // ============================================================
      //  LISTENINGS
      // ============================================================
      async function loadListenings() {
        const c = document.getElementById("listenings-list-container");
        c.innerHTML = '<p class="text-sm text-gray">Loading...</p>';
        try {
          const data = await apiGet("/ielts-listening?limit=100");
          const items = data.data || data;
          if (!items || !items.length) {
            c.innerHTML =
              '<div class="empty-state"><div class="icon">üéß</div><h3>No listenings yet</h3></div>';
            return;
          }
          c.innerHTML = `<table class="data-table">
      <thead><tr><th>Title</th><th>Test ID</th><th>ID</th><th>Actions</th></tr></thead>
      <tbody>${items
        .map(
          (l) => `<tr>
        <td class="fw-600">${l.title || "-"}</td>
        <td><span class="id-badge" onclick="copyId('${l.test_id || ""}')">${truncId(l.test_id)}</span></td>
        <td><span class="id-badge" onclick="copyId('${l.id}')">${truncId(l.id)}</span></td>
        <td class="actions">
          <button class="btn btn-primary btn-xs" onclick="createListeningPartFor('${l.id}')">+ Part</button>
        </td>
      </tr>`,
        )
        .join("")}</tbody></table>`;
        } catch (e) {
          c.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
        }
      }

      function showCreateListeningForm() {
        document.getElementById("listening-title").value = "";
        document.getElementById("listening-description").value = "";
        document.getElementById("listening-test-id").value = "";
        document.getElementById("listening-full-audio").value = "";
        showPage("page-listening-form");
      }

      async function saveListening() {
        try {
          const body = {
            title: document.getElementById("listening-title").value,
            test_id:
              document.getElementById("listening-test-id").value || undefined,
            description:
              document.getElementById("listening-description").value ||
              undefined,
            full_audio_url:
              document.getElementById("listening-full-audio").value ||
              undefined,
          };
          const r = await apiPost("/ielts-listening", body);
          toast(`Listening created! ID: ${r.id}`);
          navigateTo("listenings");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      // ============================================================
      //  LISTENING PARTS
      // ============================================================
      let lpQuestionGroups = [];

      async function loadListeningParts() {
        const c = document.getElementById("listening-parts-list-container");
        c.innerHTML = '<p class="text-sm text-gray">Loading...</p>';
        try {
          const data = await apiGet("/ielts-listening-parts?limit=100");
          const items = data.data || data;
          if (!items || !items.length) {
            c.innerHTML =
              '<div class="empty-state"><div class="icon">üîä</div><h3>No listening parts yet</h3></div>';
            return;
          }
          c.innerHTML = `<table class="data-table">
      <thead><tr><th>Part</th><th>Title</th><th>Listening ID</th><th>ID</th><th>Actions</th></tr></thead>
      <tbody>${items
        .map(
          (p) => `<tr>
        <td class="fw-600">${p.part}</td>
        <td>${p.title || "-"}</td>
        <td><span class="id-badge" onclick="copyId('${p.listening_id || ""}')">${truncId(p.listening_id)}</span></td>
        <td><span class="id-badge" onclick="copyId('${p.id}')">${truncId(p.id)}</span></td>
        <td class="actions">
          <button class="btn btn-outline btn-xs" onclick="editListeningPart('${p.id}')">Edit</button>
          <button class="btn btn-danger btn-xs" onclick="deleteListeningPart('${p.id}')">Del</button>
        </td>
      </tr>`,
        )
        .join("")}</tbody></table>`;
        } catch (e) {
          c.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
        }
      }

      let lpEditId = null;

      function showCreateListeningPartForm() {
        lpEditId = null;
        lpQuestionGroups = [];
        document.getElementById("lp-listening-id").value = "";
        document.getElementById("lp-part").value = "PART_1";
        document.getElementById("lp-title").value = "";
        document.getElementById("lp-audio-url").value = "";
        document.getElementById("lp-audio-name").value = "";
        document.getElementById("lp-audio-duration").value = "";
        document.getElementById("lp-answers").value = "";
        document.querySelector(
          "#page-listening-part-form .card-header h3",
        ).textContent = "Create Listening Part";
        renderLpQuestionGroups();
        showPage("page-listening-part-form");
      }

      async function editListeningPart(id) {
        try {
          const p = await apiGet(`/ielts-listening-parts/${id}`);
          lpEditId = p.id;
          document.getElementById("lp-listening-id").value =
            p.listening_id || "";
          document.getElementById("lp-part").value = p.part || "PART_1";
          document.getElementById("lp-title").value = p.title || "";
          document.getElementById("lp-audio-url").value =
            (p.audio && p.audio.url) || "";
          document.getElementById("lp-audio-name").value =
            (p.audio && p.audio.file_name) || "";
          document.getElementById("lp-audio-duration").value =
            (p.audio && p.audio.duration) || "";
          document.getElementById("lp-answers").value = p.answers
            ? JSON.stringify(p.answers, null, 2)
            : "";
          lpQuestionGroups = (p.questions || []).map((q) => ({
            number_of_questions: q.number_of_questions || 0,
            contents: (q.contents || []).map((c) => ({ ...c })),
          }));
          document.querySelector(
            "#page-listening-part-form .card-header h3",
          ).textContent = "Edit Listening Part";
          renderLpQuestionGroups();
          showPage("page-listening-part-form");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      function lpAddQuestionGroup() {
        lpQuestionGroups.push({ number_of_questions: 10, contents: [] });
        renderLpQuestionGroups();
      }
      function lpRemoveQuestionGroup(idx) {
        lpQuestionGroups.splice(idx, 1);
        renderLpQuestionGroups();
      }
      function renderLpQuestionGroups() {
        renderQuestionGroups("lp-question-groups", lpQuestionGroups, "lp");
      }

      async function saveListeningPart() {
        try {
          let answers = null;
          const av = document.getElementById("lp-answers").value.trim();
          if (av) {
            try {
              answers = JSON.parse(av);
            } catch (e) {
              toast("Invalid JSON in answers", "error");
              return;
            }
          }
          const audioUrl = document.getElementById("lp-audio-url").value;
          const body = {
            listening_id: document.getElementById("lp-listening-id").value,
            part: document.getElementById("lp-part").value,
            title: document.getElementById("lp-title").value || null,
            answers,
            audio: audioUrl
              ? {
                  url: audioUrl,
                  file_name:
                    document.getElementById("lp-audio-name").value || null,
                  duration:
                    parseInt(
                      document.getElementById("lp-audio-duration").value,
                    ) || null,
                }
              : null,
            questions: lpQuestionGroups.map((q) => ({
              number_of_questions: q.number_of_questions,
              contents: q.contents.map(buildContentPayload),
            })),
          };
          if (lpEditId) {
            await apiPatch(`/ielts-listening-parts/${lpEditId}`, body);
            toast("Listening part updated!");
          } else {
            const r = await apiPost("/ielts-listening-parts", body);
            toast(`Listening part created! ID: ${r.id}`);
          }
          lpEditId = null;
          navigateTo("listening-parts");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      async function deleteListeningPart(id) {
        if (!confirm("Delete this listening part?")) return;
        try {
          await apiDelete(`/ielts-listening-parts/${id}`);
          toast("Deleted!");
          loadListeningParts();
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      // ============================================================
      //  WRITINGS
      // ============================================================
      async function loadWritings() {
        const c = document.getElementById("writings-list-container");
        c.innerHTML = '<p class="text-sm text-gray">Loading...</p>';
        try {
          const data = await apiGet("/ielts-writing?limit=100");
          const items = data.data || data;
          if (!items || !items.length) {
            c.innerHTML =
              '<div class="empty-state"><div class="icon">‚úçÔ∏è</div><h3>No writings yet</h3></div>';
            return;
          }
          c.innerHTML = `<table class="data-table">
      <thead><tr><th>Title</th><th>Test ID</th><th>ID</th><th>Actions</th></tr></thead>
      <tbody>${items
        .map(
          (w) => `<tr>
        <td class="fw-600">${w.title || "-"}</td>
        <td><span class="id-badge" onclick="copyId('${w.test_id || ""}')">${truncId(w.test_id)}</span></td>
        <td><span class="id-badge" onclick="copyId('${w.id}')">${truncId(w.id)}</span></td>
        <td class="actions">
          <button class="btn btn-primary btn-xs" onclick="createWritingTaskFor('${w.id}')">+ Task</button>
        </td>
      </tr>`,
        )
        .join("")}</tbody></table>`;
        } catch (e) {
          c.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
        }
      }

      function showCreateWritingForm() {
        document.getElementById("writing-title").value = "";
        document.getElementById("writing-description").value = "";
        document.getElementById("writing-test-id").value = "";
        showPage("page-writing-form");
      }

      async function saveWriting() {
        try {
          const body = {
            title: document.getElementById("writing-title").value,
            description:
              document.getElementById("writing-description").value || undefined,
            test_id:
              document.getElementById("writing-test-id").value || undefined,
          };
          const r = await apiPost("/ielts-writing", body);
          toast(`Writing created! ID: ${r.id}`);
          navigateTo("writings");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      // ============================================================
      //  WRITING TASKS
      // ============================================================
      async function loadWritingTasks() {
        // No direct list-all endpoint; show guidance
        const c = document.getElementById("writing-tasks-list-container");
        c.innerHTML =
          '<div class="empty-state"><div class="icon">üìù</div><h3>Writing Tasks</h3><p>Create tasks from a Writing section (use "+ Task" button), or click "+ Create Task" above.</p></div>';
      }

      function showCreateWritingTaskForm() {
        document.getElementById("wt-writing-id").value = "";
        document.getElementById("wt-task").value = "TASK_1";
        document.getElementById("wt-prompt").value = "";
        document.getElementById("wt-instructions").value = "";
        document.getElementById("wt-min-words").value = "150";
        document.getElementById("wt-suggested-time").value = "20";
        showPage("page-writing-task-form");
      }

      async function saveWritingTask() {
        try {
          const body = {
            writing_id: document.getElementById("wt-writing-id").value,
            task: document.getElementById("wt-task").value,
            prompt: document.getElementById("wt-prompt").value || null,
            instructions:
              document.getElementById("wt-instructions").value || null,
            min_words:
              parseInt(document.getElementById("wt-min-words").value) || 150,
            suggested_time:
              parseInt(document.getElementById("wt-suggested-time").value) ||
              20,
          };
          const r = await apiPost("/ielts-writing/task", body);
          toast(`Writing task created! ID: ${r.id}`);
          navigateTo("writing-tasks");
        } catch (e) {
          toast(`Error: ${e.message}`, "error");
        }
      }

      // ============================================================
      //  SHARED: QUESTION GROUPS RENDERER
      // ============================================================
      let currentQcTarget = null;
      let qcOptions = [];
      let qcMcqs = [];

      function renderQuestionGroups(containerId, groups, prefix) {
        const c = document.getElementById(containerId);
        if (!groups.length) {
          c.innerHTML =
            '<p class="text-sm text-gray">No question groups. Click "+ Add Group".</p>';
          return;
        }
        c.innerHTML = groups
          .map(
            (g, gi) => `
    <div class="part-card mb-3">
      <div class="part-card-header" onclick="togglePartCard(this)">
        <h4><span class="chevron">‚ñº</span> Group ${gi + 1} <span style="font-weight:400;font-size:12px;color:var(--gray-400)">(${g.contents.length} content blocks)</span></h4>
        <div class="flex gap-2">
          <button class="btn btn-primary btn-xs" onclick="event.stopPropagation(); openQcModal('${prefix}', ${gi})">+ Content</button>
          <button class="btn btn-danger btn-xs" onclick="event.stopPropagation(); ${prefix}RemoveQuestionGroup(${gi})">üóë</button>
        </div>
      </div>
      <div class="part-card-body">
        <div class="form-group">
          <label>Number of Questions</label>
          <input type="number" class="form-control" style="width:120px" value="${g.number_of_questions}"
            onchange="${prefix}QuestionGroups[${gi}].number_of_questions=parseInt(this.value)||0" />
        </div>
        ${
          g.contents.length
            ? g.contents
                .map(
                  (ct, ci) => `
          <div class="question-block">
            <div class="question-block-header">
              <div class="flex items-center gap-2">
                <span class="type-badge type-${ct.type}">${ct.type}</span>
                <span class="fw-600 text-sm">${ct.title || "Untitled"}</span>
              </div>
              <button class="btn btn-danger btn-xs" onclick="${prefix}RemoveContent(${gi}, ${ci})">üóë</button>
            </div>
            ${ct.condition ? `<p class="text-sm text-gray">${truncate(ct.condition, 120)}</p>` : ""}
            ${ct.options && ct.options.length ? `<div class="text-sm text-gray mt-2">Options: ${ct.options.map((o) => o.label).join(", ")}</div>` : ""}
            ${ct.multipleChoiceQuestions && ct.multipleChoiceQuestions.length ? `<div class="text-sm text-gray mt-2">${ct.multipleChoiceQuestions.length} MCQ(s)</div>` : ""}
          </div>
        `,
                )
                .join("")
            : '<p class="text-sm text-gray mt-2">No content blocks yet.</p>'
        }
      </div>
    </div>
  `,
          )
          .join("");
      }

      function rpRemoveContent(gi, ci) {
        rpQuestionGroups[gi].contents.splice(ci, 1);
        renderRpQuestionGroups();
      }
      function lpRemoveContent(gi, ci) {
        lpQuestionGroups[gi].contents.splice(ci, 1);
        renderLpQuestionGroups();
      }

      function togglePartCard(header) {
        header.classList.toggle("collapsed");
        header.nextElementSibling.classList.toggle("collapsed");
      }

      function buildContentPayload(c) {
        const block = {
          type: c.type,
          title: c.title,
          condition: c.condition || null,
          content: c.content || null,
          limit: c.limit,
          showOptions: c.showOptions,
          optionsTitle: c.optionsTitle || null,
          order: c.order,
        };
        if (c.options && c.options.length)
          block.options = c.options.map((o, i) => ({
            value: o.value,
            label: o.label,
            order: o.order || i + 1,
          }));
        if (c.multipleChoiceQuestions && c.multipleChoiceQuestions.length) {
          block.multipleChoiceQuestions = c.multipleChoiceQuestions.map(
            (m, i) => ({
              question: m.question,
              order: m.order || i + 1,
              options: m.options.map((o, j) => ({
                value: o.value,
                label: o.label,
                order: o.order || j + 1,
              })),
            }),
          );
        }
        return block;
      }

      // ============================================================
      //  QUESTION CONTENT MODAL
      // ============================================================
      function openQcModal(prefix, groupIndex) {
        currentQcTarget = { prefix, groupIndex };
        qcOptions = [];
        qcMcqs = [];
        document.getElementById("qc-type").value = "completion";
        document.getElementById("qc-title").value = "";
        document.getElementById("qc-condition").value = "";
        document.getElementById("qc-content").value = "";
        document.getElementById("qc-limit").value = "";
        document.getElementById("qc-order").value = "";
        document.getElementById("qc-show-options").checked = true;
        document.getElementById("qc-options-title").value = "";
        document.getElementById("qc-options-list").innerHTML = "";
        document.getElementById("qc-mcq-list").innerHTML = "";
        onQcTypeChange();
        openModal("qc-modal");
      }

      function onQcTypeChange() {
        const type = document.getElementById("qc-type").value;
        const hasOpts = [
          "selection",
          "draggable-selection",
          "matching-information",
        ].includes(type);
        const isMcq = ["multiple-choice", "multi-select"].includes(type);
        document.getElementById("qc-options-builder").style.display = hasOpts
          ? "block"
          : "none";
        document.getElementById("qc-mcq-builder").style.display = isMcq
          ? "block"
          : "none";
        document.getElementById("qc-show-options-group").style.display = hasOpts
          ? "block"
          : "none";
        document.getElementById("qc-options-title-group").style.display =
          hasOpts ? "block" : "none";
      }

      function qcAddOption() {
        const letter = String.fromCharCode(65 + qcOptions.length);
        qcOptions.push({
          value: letter.toLowerCase(),
          label: "",
          order: qcOptions.length + 1,
        });
        renderQcOptions();
      }

      function renderQcOptions() {
        document.getElementById("qc-options-list").innerHTML = qcOptions
          .map(
            (o, i) => `
    <div class="option-row">
      <span class="option-label">${String.fromCharCode(65 + i)}</span>
      <input type="text" class="form-control" placeholder="Option label" value="${o.label}"
        onchange="qcOptions[${i}].label=this.value;qcOptions[${i}].value='${String.fromCharCode(97 + i)}'" />
      <button class="btn btn-danger btn-xs" onclick="qcOptions.splice(${i},1);renderQcOptions()">√ó</button>
    </div>
  `,
          )
          .join("");
      }

      function qcAddMcq() {
        qcMcqs.push({ question: "", order: qcMcqs.length + 1, options: [] });
        renderQcMcqs();
      }

      function renderQcMcqs() {
        document.getElementById("qc-mcq-list").innerHTML = qcMcqs
          .map(
            (m, mi) => `
    <div class="mcq-item">
      <div class="form-group mb-2">
        <input type="text" class="form-control" placeholder="Question text..." value="${m.question}"
          onchange="qcMcqs[${mi}].question=this.value" />
      </div>
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray">Options:</span>
        <button class="btn btn-outline btn-xs" onclick="qcAddMcqOption(${mi})">+ Option</button>
      </div>
      <div class="options-list">
        ${m.options
          .map(
            (o, oi) => `
          <div class="option-row">
            <span class="option-label">${String.fromCharCode(65 + oi)}</span>
            <input type="text" class="form-control" placeholder="Option text" value="${o.label}"
              onchange="qcMcqs[${mi}].options[${oi}].label=this.value;qcMcqs[${mi}].options[${oi}].value='${String.fromCharCode(97 + oi)}'" />
            <button class="btn btn-danger btn-xs" onclick="qcMcqs[${mi}].options.splice(${oi},1);renderQcMcqs()">√ó</button>
          </div>
        `,
          )
          .join("")}
      </div>
      <div style="text-align:right;margin-top:6px"><button class="btn btn-danger btn-xs" onclick="qcMcqs.splice(${mi},1);renderQcMcqs()">Remove MCQ</button></div>
    </div>
  `,
          )
          .join("");
      }

      function qcAddMcqOption(mi) {
        const letter = String.fromCharCode(97 + qcMcqs[mi].options.length);
        qcMcqs[mi].options.push({
          value: letter,
          label: "",
          order: qcMcqs[mi].options.length + 1,
        });
        renderQcMcqs();
      }

      function qcSaveContent() {
        if (!currentQcTarget) return;
        const { prefix, groupIndex } = currentQcTarget;
        const groups = prefix === "rp" ? rpQuestionGroups : lpQuestionGroups;

        const content = {
          type: document.getElementById("qc-type").value,
          title: document.getElementById("qc-title").value,
          condition: document.getElementById("qc-condition").value,
          content: document.getElementById("qc-content").value,
          limit: parseInt(document.getElementById("qc-limit").value) || null,
          showOptions: document.getElementById("qc-show-options").checked,
          optionsTitle: document.getElementById("qc-options-title").value,
          order:
            parseInt(document.getElementById("qc-order").value) ||
            groups[groupIndex].contents.length + 1,
          options: [...qcOptions],
          multipleChoiceQuestions: qcMcqs.map((m) => ({
            question: m.question,
            order: m.order,
            options: [...m.options],
          })),
        };

        groups[groupIndex].contents.push(content);
        closeModal("qc-modal");
        prefix === "rp" ? renderRpQuestionGroups() : renderLpQuestionGroups();
        toast("Content block added!");
      }

      // ============================================================
      //  MODAL OVERLAY CLOSE
      // ============================================================
      document.querySelectorAll(".modal-overlay").forEach((ov) => {
        ov.addEventListener("click", (e) => {
          if (e.target === ov) ov.classList.remove("open");
        });
      });

      // ============================================================
      //  INIT
      // ============================================================
      loadTests();
    </script>
  </body>
</html>
